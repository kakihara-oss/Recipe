# CLAUDE.md - 感動創出レシピツール（Kando Recipe）

## プロジェクトビジョン

**「料理の可能性を拡張する感動創出のレシピツール」**

単なる調理方法の管理ではなく、料理とサービスを通じてお客様の人生に感動を届けるためのプラットフォーム。
レシピを中心に、シェフ・サービス・食材調達・総合プロデューサーが
店舗フィロソフィーに共感する仲間として一体となり、
商品とサービスを継続的にブラッシュアップしていく。

### レシピの位置づけ

レシピは「調理手順書」ではなく **「感動の設計図」**。以下の要素を統合する:
- **調理**: 食材の選定、調理手順、技法、温度管理
- **サービス**: 盛り付け、提供方法、顧客への声かけ、演出、ストーリーテリング
- **体験設計**: お客様にどんな感動を届けるか、記念日対応、季節の演出、五感への訴求
- **ナレッジ**: 料理の歴史、文化的背景、食材の物語、感動を生んだ事例

### コアバリュー
- 料理を如何にサービスに活かすか
- サービスを如何に料理に活かすか
- 料理とサービスを如何にお客様の人生に活かすか

商品はシェフだけでは完成しない。お客様の反応を元にブラッシュアップし続け、
商品開発・改良、サービス開発・改良の際にはAIに相談できる機能と、
そのためのナレッジ（感動を生む調理方法、演出方法、サービス方法、発信方法、歴史や事例など）を
組み込んでおくことで、チーム全員の創造性を拡張する。

## プロジェクト概要

- バックエンド: Spring Boot 3.x / Java 17 / Gradle
- データベース: PostgreSQL + Flyway（マイグレーション）
- 認証: Spring Security + Google OAuth2/OIDC（Google Workspace SSO）
- AI連携: LLM API（Claude API等）+ ナレッジベースによるコンテキスト付き相談
- API形式: REST API（フロントエンドはReact別リポジトリ）

---

## 開発フェーズ

### フェーズ1: プロジェクト基盤
Gradle初期化、Spring Boot設定、パッケージ構成、共通例外クラス、グローバル例外ハンドラ、定数クラス

### フェーズ2: Google Workspace認証 & アクセス制御
Google OAuth2ログイン（会社ドメイン限定）、Userエンティティ、ロール管理、
JWT発行、権限チェック、PRODUCERによるアクセス権限管理

### フェーズ3: 感動創出レシピ（コア機能）
Recipe・RecipeIngredient・CookingStep・ServiceDesign・ExperienceDesign、
RecipeHistory（変更履歴）、レシピCRUD API、ページネーション

### フェーズ4: ナレッジベース & AI相談
KnowledgeCategory・KnowledgeArticle（ナレッジ記事管理）、
AI相談機能（LLM連携・ナレッジをコンテキストとした対話型相談）、レシピ×ナレッジ連携

### フェーズ5: お客様フィードバック & 満足度・感動度
ProductFeedback（商品別の満足度・感動度の記録）、FeedbackSummary（集計・分析）、
フィードバックを元にしたレシピ改善サイクルの支援

### フェーズ6: 食材マスタ & 原価管理
Ingredient・IngredientPrice・IngredientSeason（食材マスタ・価格履歴・旬情報）、
RecipeCost（原価自動計算・推奨売価）、食材変更の影響分析、アーカイブ連動

### フェーズ7: 店舗・POSデータ & 経営分析
Store（店舗マスタ）、MonthlySales（POSデータCSV取込）、
StoreMonthlyFoodCost（理論原価）、店舗間比較、月次推移、満足度×収益クロス分析

---

## パッケージ構成

```
com.recipe.manager
├── config/          # Security, OAuth2, Web, DB, AI設定
├── controller/      # REST Controller
├── service/         # ビジネスロジック
├── repository/      # Spring Data JPA Repository
├── entity/          # JPA Entity
├── dto/
│   ├── request/     # リクエストDTO
│   └── response/    # レスポンスDTO
├── exception/       # カスタム例外
├── security/        # OAuth2, JWT, 認証・認可
├── ai/              # AI連携（LLMクライアント、プロンプト管理）
└── common/          # 定数, ユーティリティ
```

---

## 主要エンティティ

### レシピ関連（フェーズ3）
- Recipe: レシピ本体（タイトル、説明、カテゴリ、人数、ステータス、コンセプト、ストーリー）
- RecipeIngredient: レシピ内の食材情報（食材マスタへの参照、使用量、単位、下処理メモ、代替食材）
- CookingStep: 調理手順（手順番号、説明、所要時間、温度、コツ）
- ServiceDesign: サービス設計（盛り付け指示、提供方法、顧客への声かけスクリプト、演出方法、タイミング、ストーリーテリング要素）
- ExperienceDesign: 体験設計（ターゲットシーン、期待する感動ポイント、記念日対応、季節演出、五感への訴求）

### ナレッジ関連（フェーズ4）
- KnowledgeCategory: ナレッジカテゴリ（調理技法、演出方法、サービス手法、発信方法、歴史・文化、感動事例）
- KnowledgeArticle: ナレッジ記事（タイトル、本文、カテゴリ、タグ、投稿者、関連レシピ）
- AiConsultationThread: AI相談スレッド（ユーザー、関連レシピ、相談テーマ）
- AiConsultationMessage: AI相談メッセージ（スレッド、送信者種別[USER/AI]、メッセージ本文、参照ナレッジ）

### フィードバック関連（フェーズ5）
- ProductFeedback: 商品フィードバック（レシピ、店舗、評価期間、満足度スコア、感動度スコア（仮）、定性コメント、収集方法）
- FeedbackSummary: フィードバック集計（レシピ、期間、平均満足度、平均感動度、件数、主要コメント傾向）

### 食材マスタ関連（フェーズ6）
- Ingredient: 食材マスタ（食材名、カテゴリ、標準単位、季節フラグ、供給状態、仕入先）
- IngredientPrice: 食材価格履歴（単価、有効開始日、有効終了日） ※時系列で価格変動を追跡
- IngredientSeason: 食材の旬情報（対象月、入手性ランク、品質メモ）

### 原価・売価関連（フェーズ6）
- RecipeCost: レシピ原価情報（食材原価合計、目標粗利率、推奨売価、現在売価、最終計算日時）

### 店舗・売上関連（フェーズ7）
- Store: 店舗マスタ（店舗コード、店舗名、所在地）
- MonthlySales: 月次売上データ（店舗、レシピ、対象年月、出数、売上金額） ※POSデータCSVから取り込み
- StoreMonthlyFoodCost: 店舗月次理論原価（店舗、対象年月、理論原価合計、売上合計、理論原価率） ※計算結果のスナップショット

### ユーザー・履歴関連（フェーズ2-3）
- User: ユーザー（CHEF / SERVICE / PURCHASER / PRODUCER、Googleアカウント連携情報）
- RecipeHistory: 更新履歴（誰が・いつ・何を変更したか）

### ステータス管理
- Recipeステータス: DRAFT → PUBLISHED ←→ ARCHIVED → DELETED（論理削除）
  - DRAFT: 下書き。作成中のレシピ
  - PUBLISHED: 公開中。店舗で使用中
  - ARCHIVED: アーカイブ。季節メニュー終了時など一時的に非公開。再公開可能
  - DELETED: 論理削除。通常のクエリでは取得されない
- Ingredient供給状態: AVAILABLE（供給可能）/ LIMITED（供給不安定）/ UNAVAILABLE（供給停止）/ SEASONAL（季節限定）

---

## ロール定義

| ロール | 日本語名 | 役割 |
|--------|---------|------|
| CHEF | シェフ | 調理の専門家。レシピの調理面を設計・管理する |
| SERVICE | サービス | 接客の専門家。サービス設計・体験設計を担い、お客様の反応をフィードバックする |
| PURCHASER | 食材調達 | 食材の専門家。食材マスタ・原価情報を管理し、最適な食材調達を行う |
| PRODUCER | 総合プロデューサー | 全体統括。商品戦略・メンバー管理・経営判断を行う |

## 権限モデル

| 操作 | CHEF | SERVICE | PURCHASER | PRODUCER |
|------|------|---------|-----------|----------|
| レシピ作成 | o | x | x | o |
| レシピ更新（調理面: CookingStep, RecipeIngredient） | o | x | x | o |
| レシピ更新（サービス・体験面: ServiceDesign, ExperienceDesign） | o | o | x | o |
| レシピ削除 | o | x | x | o |
| ステータス変更（公開・アーカイブ） | o | x | x | o |
| レシピ閲覧 | o | o | o | o |
| ナレッジ記事の投稿 | o | o | o | o |
| ナレッジ記事の編集・削除 | 自分の記事 | 自分の記事 | 自分の記事 | 全記事 |
| AI相談の利用 | o | o | o | o |
| フィードバック登録 | o | o | x | o |
| フィードバック閲覧 | o | o | o | o |
| 食材マスタ登録・更新 | x | x | o | o |
| 食材価格更新 | x | x | o | o |
| 食材供給状態変更 | x | x | o | o |
| 原価・売価情報の閲覧 | o | x | o | o |
| 売価の更新 | o | x | o | o |
| 影響レシピ一覧の取得 | o | o | o | o |
| 店舗マスタ登録・更新 | x | x | x | o |
| POSデータCSVアップロード | x | o | o | o |
| 店舗別理論原価の閲覧 | o | o | o | o |
| アクセス権限管理（ロール付与・変更） | x | x | x | o |

---

## 認証・認可アーキテクチャ

### Google Workspace SSO
- Google OAuth2/OpenID Connectによるログイン
- 会社ドメイン（Google Workspace管理下）のGoogleアカウントのみログイン許可
- ドメイン制限はOAuth2トークン検証時にメールドメインでチェック
- 初回ログイン時にUserエンティティを自動作成（デフォルトロールはPRODUCERが事前設定 or 申請制）

### JWT
- Google認証成功後、アプリケーション独自のJWTを発行
- JWTにはユーザーID・ロール・有効期限を含む
- 以降のAPI呼び出しはJWTで認証・認可

### アクセス権限管理
- PRODUCERがユーザー一覧からロールを付与・変更できる
- ログイン可能=会社ドメインのGoogleアカウント保持者
- 何ができるか=付与されたロールによって決まる

---

## AI相談機能アーキテクチャ（フェーズ4）

### 概要
商品開発・改良、サービス開発・改良の際に、AIに対話形式で相談できる。
ナレッジベースの記事をコンテキストとして活用し、店舗のフィロソフィーや過去の感動事例に基づいたアドバイスを得られる。

### ナレッジベース
以下のカテゴリでナレッジ記事を蓄積する:
- **調理技法**: 食材の活かし方、調理の工夫、プロの技
- **演出方法**: 盛り付け、照明、音楽、香り、サプライズ演出
- **サービス手法**: 接客話法、おもてなしの心得、クレーム対応の好事例
- **発信方法**: SNS映え、メニュー説明文の書き方、ストーリーの伝え方
- **歴史・文化**: 料理の起源、食文化、地域性、食材の物語
- **感動事例**: 実際にお客様に感動を届けた事例、成功パターン

### AI相談フロー
1. ユーザーが相談テーマを選択（新商品開発、既存メニュー改良、サービス改善 等）
2. 関連するレシピがあれば紐づけ
3. システムがナレッジベースから関連記事を検索し、LLMのコンテキストに含める
4. ユーザーとAIが対話形式で相談
5. 相談履歴はスレッドとして保存され、後から振り返り可能

### フロントエンド画面設計

#### 画面構成

AI相談機能は2つのページで構成する:

**1. AI相談メインページ (`/ai`, `/ai/threads/:threadId`)**

2ペイン（左右分割）レイアウト:

```
┌──────────────┬─────────────────────────────┐
│ スレッド一覧   │  チャットエリア               │
│ (幅: 300px)  │  (残りの幅)                  │
│              │                             │
│ [+新規相談]   │  テーマ: ○○○                 │
│              │  関連レシピ: △△△              │
│ ▶ スレッド1   │                             │
│   スレッド2   │  ┌─────────────────────┐    │
│   スレッド3   │  │ USER: メッセージ...    │    │
│              │  └─────────────────────┘    │
│              │  ┌─────────────────────┐    │
│              │  │ AI: 回答...           │    │
│              │  │ [参考: 記事1] [記事2]  │    │
│              │  └─────────────────────┘    │
│              │                             │
│              │  ┌─────────────────────┐    │
│              │  │ メッセージを入力...     │ 送信│
│              │  └─────────────────────┘    │
└──────────────┴─────────────────────────────┘
```

- 左ペイン: 自分のスレッド一覧（更新日時の新しい順）。ページネーション対応
- 右ペイン: 選択中のスレッドのチャット画面
- スレッド未選択時: 右ペインに「相談を選択するか、新規相談を始めてください」と表示
- モバイル時: 左ペインを折りたたみメニューに変更（ハンバーガーボタンで開閉）

**2. 新規相談作成ページ (`/ai/new`)**

```
┌─────────────────────────────────────────────┐
│ 新規AI相談                                    │
├─────────────────────────────────────────────┤
│                                             │
│ 相談テーマ *                                  │
│ ┌─────────────────────────────────────┐     │
│ │ 例: 春の新作デザートのサービス演出      │     │
│ └─────────────────────────────────────┘     │
│                                             │
│ 関連レシピ（任意）                             │
│ ┌──────────────────────────────┐            │
│ │ レシピを検索...          [▼] │            │
│ └──────────────────────────────┘            │
│                                             │
│ 最初のメッセージ *                             │
│ ┌─────────────────────────────────────┐     │
│ │ AIに相談したい内容を入力...            │     │
│ │                                     │     │
│ │                                     │     │
│ └─────────────────────────────────────┘     │
│                                             │
│                         [相談を始める]        │
└─────────────────────────────────────────────┘
```

- 相談テーマ: 必須、最大200文字
- 関連レシピ: 任意、既存レシピからドロップダウンで選択
- 最初のメッセージ: 必須、テキストエリア
- 送信後: AI相談メインページの該当スレッドに自動遷移

#### チャットUI仕様

**メッセージ表示**:
- USERメッセージ: 右寄せ、背景色付き（例: 青系）
- AIメッセージ: 左寄せ、背景色付き（例: グレー系）、Markdownレンダリング対応
- AIメッセージの参考記事: メッセージ下部にリンクバッジとして表示。クリックでナレッジ記事詳細に遷移
- タイムスタンプ: 各メッセージの下に小さく表示

**メッセージ入力・送信**:
- テキストエリア + 送信ボタン
- Enter で送信、Shift+Enter で改行
- 送信中は入力欄を無効化し、ローディングインジケーターを表示
- 空メッセージは送信不可（ボタン無効化）

**スクロール**:
- 新しいメッセージが追加されたら自動で最下部にスクロール
- チャットエリアは独立スクロール（ページ全体はスクロールしない）

#### 対応するバックエンドAPI

| 操作 | API | 画面 |
|------|-----|------|
| スレッド作成 | `POST /api/ai/threads` | 新規相談作成ページ |
| スレッド一覧取得 | `GET /api/ai/threads` | 左ペイン |
| スレッド詳細取得 | `GET /api/ai/threads/{threadId}` | チャットヘッダー |
| メッセージ一覧取得 | `GET /api/ai/threads/{threadId}/messages` | チャットエリア |
| メッセージ送信 | `POST /api/ai/threads/{threadId}/messages` | メッセージ入力欄 |

#### フロントエンドファイル構成

- `src/api/ai.ts` — API呼び出し関数
- `src/hooks/useAi.ts` — TanStack Query hooks（スレッド一覧・メッセージ取得・送信）
- `src/pages/ai/AiConsultationPage.tsx` — 2ペインメインページ
- `src/pages/ai/AiNewThreadPage.tsx` — 新規相談作成ページ
- `src/components/ai/ThreadList.tsx` — スレッド一覧（左ペイン）
- `src/components/ai/ChatMessage.tsx` — チャット吹き出し（USER/AI切り替え）
- `src/components/ai/ChatInput.tsx` — メッセージ入力欄
- `src/components/ai/ReferencedArticles.tsx` — 参考ナレッジ記事のリンク表示

#### アクセス権限

- 全ロール（CHEF, SERVICE, PURCHASER, PRODUCER）が利用可能
- 自分のスレッドのみ表示・操作可能（PRODUCERは全スレッドにアクセス可能）

---

## レシピ管理フロントエンド画面設計（フェーズ3）

### 画面構成

レシピ管理は7ページで構成する:

**1. レシピ一覧ページ (`/recipes`)**

```
┌─────────────────────────────────────────────────┐
│ レシピ一覧                         [+ 新規作成]   │
├─────────────────────────────────────────────────┤
│ [全て] [DRAFT] [PUBLISHED] [ARCHIVED]  カテゴリ▼  │
├─────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│ │ レシピA   │ │ レシピB   │ │ レシピC   │         │
│ │ カテゴリ   │ │ カテゴリ   │ │ カテゴリ   │         │
│ │ PUBLISHED │ │ DRAFT    │ │ ARCHIVED │         │
│ │ 4人前     │ │ 2人前     │ │ 6人前     │         │
│ │ 更新: 2/26 │ │ 更新: 2/25│ │ 更新: 2/20│         │
│ └──────────┘ └──────────┘ └──────────┘         │
│                                                 │
│            < 1  2  3  4  5 >                    │
└─────────────────────────────────────────────────┘
```

- カード形式でレシピを一覧表示
- ステータスフィルタ: タブ切り替え（DRAFT / PUBLISHED / ARCHIVED / 全て）
- カテゴリフィルタ: ドロップダウン（自由入力のため、既存カテゴリの一覧から選択）
- ページネーション: デフォルト20件/ページ、最大100件
- 「新規作成」ボタン: CHEF / PRODUCER のみ表示
- ソート: 更新日時の新しい順（バックエンド固定）

**2. レシピ詳細ページ (`/recipes/:id`)**

```
┌─────────────────────────────────────────────────┐
│ ← 一覧に戻る                                     │
│                                                 │
│ レシピタイトル                    [PUBLISHED]      │
│ カテゴリ: イタリアン  |  4人前                      │
│ 作成者: 田中シェフ  |  更新: 2026/02/26            │
│                                                 │
│ [編集] [サービス設計編集] [体験設計編集]              │
│ [公開する / アーカイブする]  [削除]                  │
│                                                 │
├─[基本情報]─[調理手順]─[サービス設計]─[体験設計]──────┤
│                                                 │
│ (選択中のタブの内容が表示される)                      │
│                                                 │
│ [変更履歴を見る]                                   │
└─────────────────────────────────────────────────┘
```

- タブ切り替え: 基本情報 / 調理手順 / サービス設計 / 体験設計
- 基本情報タブ: タイトル、説明、コンセプト、ストーリー、食材一覧
- 調理手順タブ: ステップ番号順に表示（所要時間、温度、コツ付き）
- サービス設計タブ: 盛り付け指示、提供方法、声かけスクリプト、演出、タイミング、ストーリーテリング
- 体験設計タブ: ターゲットシーン、感動ポイント、記念日対応、季節演出、五感への訴求
- ロールに応じたボタン表示/非表示（後述の権限表参照）

**3. レシピ作成ページ (`/recipes/new`)**

```
┌─────────────────────────────────────────────────┐
│ 新規レシピ作成                                    │
├─────────────────────────────────────────────────┤
│ タイトル *           [________________] (200文字)  │
│ 説明                 [________________] (2000文字) │
│ カテゴリ              [________________] (100文字)  │
│ 人数                 [__] 人前                    │
│ コンセプト            [________________]           │
│ ストーリー            [________________]           │
│                                                 │
│ ── 食材 ──                                       │
│ [食材を選択▼] [数量] [単位] [下処理メモ] [代替食材]  │
│ + 食材を追加                                      │
│                                                 │
│ ── 調理手順 ──                                    │
│ 1. [説明 *] [時間(分)] [温度] [コツ]               │
│ + 手順を追加                                      │
│                                                 │
│                    [下書き保存]  [作成]             │
└─────────────────────────────────────────────────┘
```

- タイトル: 必須、最大200文字
- 説明: 任意、最大2000文字
- カテゴリ: 任意、最大100文字（自由入力）
- 食材: 食材マスタからドロップダウン選択 + 数量・単位・メモ
- 調理手順: 動的に追加・削除・並び替え可能
- 作成後: レシピ詳細ページに遷移

**4. レシピ編集ページ (`/recipes/:id/edit`)**
- レシピ作成ページと同じフォーム構造（既存データをプリフィル）
- 基本情報（タイトル、説明、カテゴリ、人数、コンセプト、ストーリー）のみ編集

**5. サービス設計編集ページ (`/recipes/:id/service-design/edit`)**

```
┌─────────────────────────────────────────────────┐
│ サービス設計編集 — レシピ名                         │
├─────────────────────────────────────────────────┤
│ 盛り付け指示     [________________]               │
│ 提供方法         [________________]               │
│ 声かけスクリプト  [________________]               │
│ 演出方法         [________________]               │
│ タイミング       [________________]               │
│ ストーリーテリング [________________]               │
│                                                 │
│                         [キャンセル]  [保存]       │
└─────────────────────────────────────────────────┘
```

- 全フィールド任意（テキストエリア）
- CHEF / SERVICE / PRODUCER が編集可能

**6. 体験設計編集ページ (`/recipes/:id/experience-design/edit`)**
- サービス設計と同様のフォーム構造
- フィールド: ターゲットシーン、感動ポイント、記念日対応、季節演出、五感への訴求
- CHEF / SERVICE / PRODUCER が編集可能

**7. 変更履歴ページ (`/recipes/:id/history`)**

```
┌─────────────────────────────────────────────────┐
│ 変更履歴 — レシピ名                                │
├─────────────────────────────────────────────────┤
│ 2026/02/26 14:00  田中シェフ                      │
│   変更種別: UPDATE                                │
│   変更内容: title, description                    │
│                                                 │
│ 2026/02/25 10:30  佐藤(サービス)                   │
│   変更種別: UPDATE                                │
│   変更内容: serviceDesign                         │
│                                                 │
│ 2026/02/20 09:00  田中シェフ                      │
│   変更種別: CREATE                                │
│   変更内容: 新規作成                               │
└─────────────────────────────────────────────────┘
```

- タイムライン形式で変更履歴を時系列表示
- 全ロールが閲覧可能

### ロールベースUI制御

| 操作 / ボタン | CHEF | SERVICE | PURCHASER | PRODUCER |
|--------------|:----:|:-------:|:---------:|:--------:|
| 「新規作成」ボタン（一覧） | 表示 | 非表示 | 非表示 | 表示 |
| 「編集」ボタン（詳細） | 表示 | 非表示 | 非表示 | 表示 |
| 「サービス設計編集」ボタン | 表示 | 表示 | 非表示 | 表示 |
| 「体験設計編集」ボタン | 表示 | 表示 | 非表示 | 表示 |
| ステータス変更ボタン | 表示 | 非表示 | 非表示 | 表示 |
| 「削除」ボタン | 表示 | 非表示 | 非表示 | 表示 |

### 対応するバックエンドAPI

| 操作 | API | 画面 |
|------|-----|------|
| レシピ一覧取得 | `GET /api/recipes` | レシピ一覧ページ |
| レシピ詳細取得 | `GET /api/recipes/{id}` | レシピ詳細ページ |
| レシピ作成 | `POST /api/recipes` | レシピ作成ページ |
| レシピ更新 | `PUT /api/recipes/{id}` | レシピ編集ページ |
| サービス設計更新 | `PUT /api/recipes/{id}/service-design` | サービス設計編集ページ |
| 体験設計更新 | `PUT /api/recipes/{id}/experience-design` | 体験設計編集ページ |
| ステータス変更 | `PUT /api/recipes/{id}/status` | レシピ詳細ページ内ボタン |
| レシピ削除 | `DELETE /api/recipes/{id}` | レシピ詳細ページ内ボタン |
| 変更履歴取得 | `GET /api/recipes/{id}/history` | 変更履歴ページ |

### フロントエンドファイル構成

- `src/api/recipes.ts` — レシピAPI呼び出し関数
- `src/hooks/useRecipes.ts` — TanStack Query hooks（一覧・詳細・作成・更新・削除）
- `src/pages/recipes/RecipeListPage.tsx` — レシピ一覧ページ
- `src/pages/recipes/RecipeDetailPage.tsx` — レシピ詳細ページ（タブ表示）
- `src/pages/recipes/RecipeCreatePage.tsx` — レシピ作成ページ
- `src/pages/recipes/RecipeEditPage.tsx` — レシピ編集ページ
- `src/pages/recipes/ServiceDesignEditPage.tsx` — サービス設計編集ページ
- `src/pages/recipes/ExperienceDesignEditPage.tsx` — 体験設計編集ページ
- `src/pages/recipes/RecipeHistoryPage.tsx` — 変更履歴ページ
- `src/components/recipe/RecipeCard.tsx` — 一覧用レシピカード
- `src/components/recipe/RecipeStatusBadge.tsx` — ステータスバッジ
- `src/components/recipe/CookingStepForm.tsx` — 調理手順の動的フォーム
- `src/components/recipe/IngredientForm.tsx` — 食材選択の動的フォーム
- `src/components/recipe/ServiceDesignForm.tsx` — サービス設計フォーム
- `src/components/recipe/ExperienceDesignForm.tsx` — 体験設計フォーム
- `src/components/recipe/RecipeHistoryTimeline.tsx` — 変更履歴タイムライン

---

## ナレッジベースフロントエンド画面設計（フェーズ4）

### 画面構成

ナレッジベースは5ページで構成する:

**1. ナレッジ記事一覧ページ (`/knowledge`)**

```
┌─────────────────────────────────────────────────┐
│ ナレッジベース                  [検索] [+ 記事作成] │
├─────────────────────────────────────────────────┤
│ [全て][調理技法][演出方法][サービス手法][発信方法]     │
│ [歴史・文化][感動事例]                              │
├─────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────┐        │
│ │ 記事タイトル                          │        │
│ │ カテゴリ: 調理技法  タグ: 春,野菜       │        │
│ │ 投稿者: 田中  更新: 2026/02/26        │        │
│ └──────────────────────────────────────┘        │
│ ┌──────────────────────────────────────┐        │
│ │ 記事タイトル2                         │        │
│ │ ...                                  │        │
│ └──────────────────────────────────────┘        │
│            < 1  2  3  4  5 >                    │
└─────────────────────────────────────────────────┘
```

- カテゴリタブ: 6つのプリセットカテゴリ + 「全て」タブ
- カード形式で記事一覧表示
- ページネーション: デフォルト20件/ページ

**2. ナレッジ記事詳細ページ (`/knowledge/:id`)**

```
┌─────────────────────────────────────────────────┐
│ ← 一覧に戻る                                     │
│                                                 │
│ 記事タイトル                     [編集] [削除]     │
│ カテゴリ: 調理技法  タグ: 春, 野菜, 調理            │
│ 投稿者: 田中  更新: 2026/02/26                    │
│                                                 │
│ ── 本文（Markdownレンダリング） ──                  │
│ # 見出し                                         │
│ 本文テキスト...                                    │
│                                                 │
│ ── 関連レシピ ──                                   │
│ [春の新作デザート] [春野菜サラダ]                     │
└─────────────────────────────────────────────────┘
```

- 本文: Markdownをレンダリングして表示（react-markdown使用）
- 関連レシピ: クリックでレシピ詳細ページに遷移
- 編集/削除ボタン: 投稿者本人 or PRODUCER のみ表示

**3. ナレッジ記事検索ページ (`/knowledge/search`)**

- キーワード入力欄 + 検索ボタン
- タイトル・本文・タグを横断検索（`GET /api/knowledge/articles/search`）
- 検索結果をカード形式で表示（ページネーションなし、全件表示）

**4. ナレッジ記事作成ページ (`/knowledge/new`)**

- タイトル: 必須、最大200文字
- 本文: 必須、Markdown形式、テキストエリア
- カテゴリ: 必須、6カテゴリからドロップダウン選択
- タグ: 任意、カンマ区切り
- 関連レシピ: 任意、複数選択可能

**5. ナレッジ記事編集ページ (`/knowledge/:id/edit`)**

- 記事作成ページと同じフォーム構造（既存データをプリフィル）
- 投稿者本人 or PRODUCER のみアクセス可能

### 対応するバックエンドAPI

| 操作 | API | 画面 |
|------|-----|------|
| カテゴリ一覧取得 | `GET /api/knowledge/categories` | 一覧ページのタブ |
| 記事一覧取得 | `GET /api/knowledge/articles` | 一覧ページ |
| 記事詳細取得 | `GET /api/knowledge/articles/{id}` | 詳細ページ |
| 記事検索 | `GET /api/knowledge/articles/search` | 検索ページ |
| 記事作成 | `POST /api/knowledge/articles` | 作成ページ |
| 記事更新 | `PUT /api/knowledge/articles/{id}` | 編集ページ |
| 記事削除 | `DELETE /api/knowledge/articles/{id}` | 詳細ページ内ボタン |

### フロントエンドファイル構成

- `src/api/knowledge.ts` — ナレッジAPI呼び出し関数
- `src/hooks/useKnowledge.ts` — TanStack Query hooks
- `src/pages/knowledge/KnowledgeListPage.tsx` — 記事一覧ページ
- `src/pages/knowledge/KnowledgeDetailPage.tsx` — 記事詳細ページ
- `src/pages/knowledge/KnowledgeSearchPage.tsx` — 記事検索ページ
- `src/pages/knowledge/KnowledgeCreatePage.tsx` — 記事作成ページ
- `src/pages/knowledge/KnowledgeEditPage.tsx` — 記事編集ページ
- `src/components/knowledge/ArticleCard.tsx` — 記事カード
- `src/components/knowledge/CategoryFilter.tsx` — カテゴリタブフィルタ
- `src/components/knowledge/ArticleForm.tsx` — 記事入力フォーム
- `src/components/common/MarkdownRenderer.tsx` — Markdownレンダリングコンポーネント

---

## フィードバックフロントエンド画面設計（フェーズ5）

### 画面構成

フィードバック機能は4ページで構成する:

**1. フィードバック一覧ページ (`/feedbacks`)**

```
┌─────────────────────────────────────────────────┐
│ フィードバック一覧                   [+ 新規登録]   │
├─────────────────────────────────────────────────┤
│ レシピ: [全て ▼]    店舗: [全て ▼]                 │
├─────────────────────────────────────────────────┤
│ レシピ名   | 店舗  | 期間      | 満足度 | 感動度    │
│ Aランチ   | 本店  | 2/1-2/28 | ★4    | ★5      │
│ Bディナー | 支店  | 2/1-2/28 | ★3    | ★4      │
│ Aランチ   | 支店  | 1/1-1/31 | ★5    | ★5      │
│            < 1  2  3  4  5 >                    │
└─────────────────────────────────────────────────┘
```

- テーブル形式で一覧表示
- フィルタ: レシピ別、店舗別
- ページネーション: デフォルト20件/ページ
- 「新規登録」ボタン: CHEF / SERVICE / PRODUCER のみ表示（PURCHASERは非表示）

**2. フィードバック登録ページ (`/feedbacks/new`)**

```
┌─────────────────────────────────────────────────┐
│ フィードバック登録                                  │
├─────────────────────────────────────────────────┤
│ レシピ *            [レシピを選択 ▼]               │
│ 店舗                [店舗を選択 ▼]  (任意)         │
│ 対象期間 *          [開始日] 〜 [終了日]            │
│ 収集方法 *          [アンケート ▼]                 │
│                    (SURVEY/INTERVIEW/SNS/         │
│                     DIRECT/OTHER)                 │
│                                                 │
│ 満足度 * (1-5)      ★ ★ ★ ★ ☆                  │
│ 感動度   (1-5)      ★ ★ ★ ★ ★  (任意)          │
│                                                 │
│ コメント             [________________]           │
│                                                 │
│                         [キャンセル]  [登録]       │
└─────────────────────────────────────────────────┘
```

- レシピ: 必須、既存レシピからドロップダウン選択
- 店舗: 任意、既存店舗からドロップダウン選択
- 対象期間: 必須、開始日 ≤ 終了日のバリデーション
- 収集方法: 必須、SURVEY / INTERVIEW / SNS / DIRECT / OTHER から選択
- 満足度: 必須、1〜5の星評価
- 感動度: 任意、1〜5の星評価
- コメント: 任意、テキストエリア

**3. フィードバックサマリーページ (`/feedbacks/summaries`)**

```
┌─────────────────────────────────────────────────┐
│ フィードバックサマリー                              │
├─────────────────────────────────────────────────┤
│ レシピ *  [レシピを選択 ▼]                         │
│ 期間 *    [開始日] 〜 [終了日]   [集計する]         │
├─────────────────────────────────────────────────┤
│ ── 集計結果 ──                                    │
│ ┌──────────────────────────────────────┐        │
│ │ 平均満足度: 4.50  | 平均感動度: 4.75   │        │
│ │ フィードバック件数: 8件                 │        │
│ │                                      │        │
│ │ 主なコメント傾向:                      │        │
│ │ ・お客様の反応が良かった                │        │
│ │ ・盛り付けが美しい                     │        │
│ └──────────────────────────────────────┘        │
│                                                 │
│ ── 過去のサマリー一覧 ──                           │
│ (レシピ選択時に表示。ページネーション対応)             │
└─────────────────────────────────────────────────┘
```

- 上部: 集計フォーム（レシピ選択 + 期間指定 + 集計ボタン）
- 中部: 最新の集計結果を表示
- 下部: 過去のサマリー一覧（レシピIDで絞り込み）

**4. フィードバックトレンドページ (`/feedbacks/trend`)**

```
┌─────────────────────────────────────────────────┐
│ フィードバックトレンド                              │
├─────────────────────────────────────────────────┤
│ レシピ *  [レシピを選択 ▼]                         │
├─────────────────────────────────────────────────┤
│                                                 │
│  5 ┤                            ╭──── 感動度     │
│  4 ┤        ╭────────╮─────────╯                │
│  3 ┤───────╯          ╰───╮──── 満足度          │
│  2 ┤                       ╰────                │
│  1 ┤                                            │
│    └──┬──────┬──────┬──────┬──────┬──           │
│      1月    2月    3月    4月    5月              │
│                                                 │
│ (Rechartsで折れ線グラフを描画)                      │
└─────────────────────────────────────────────────┘
```

- レシピを選択すると、満足度・感動度の推移を折れ線グラフで表示
- Rechartsライブラリを使用
- X軸: 期間（periodStart順）、Y軸: スコア（1-5）

### 対応するバックエンドAPI

| 操作 | API | 画面 |
|------|-----|------|
| フィードバック一覧 | `GET /api/feedbacks` | 一覧ページ |
| フィードバック詳細 | `GET /api/feedbacks/{id}` | 一覧内クリック時 |
| フィードバック登録 | `POST /api/feedbacks` | 登録ページ |
| フィードバック削除 | `DELETE /api/feedbacks/{id}` | 一覧ページ内ボタン |
| サマリー生成 | `POST /api/feedbacks/summaries/generate` | サマリーページ |
| サマリー一覧 | `GET /api/feedbacks/summaries` | サマリーページ |
| サマリー詳細 | `GET /api/feedbacks/summaries/{id}` | サマリーページ |
| トレンド取得 | `GET /api/feedbacks/summaries/trend` | トレンドページ |

### フロントエンドファイル構成

- `src/api/feedbacks.ts` — フィードバックAPI呼び出し関数
- `src/hooks/useFeedbacks.ts` — TanStack Query hooks
- `src/pages/feedback/FeedbackListPage.tsx` — フィードバック一覧ページ
- `src/pages/feedback/FeedbackCreatePage.tsx` — フィードバック登録ページ
- `src/pages/feedback/FeedbackSummaryPage.tsx` — サマリーページ
- `src/pages/feedback/FeedbackTrendPage.tsx` — トレンドページ
- `src/components/feedback/FeedbackForm.tsx` — 登録フォーム
- `src/components/feedback/ScoreDisplay.tsx` — 星スコア表示
- `src/components/feedback/SummaryCard.tsx` — サマリーカード
- `src/components/feedback/TrendChart.tsx` — Rechartsトレンドグラフ

---

## ユーザー管理・ダッシュボードフロントエンド画面設計（フェーズ2/共通）

### 画面構成

**1. ユーザー管理ページ (`/admin/users`) — PRODUCERのみ**

```
┌─────────────────────────────────────────────────┐
│ メンバー管理                                      │
├─────────────────────────────────────────────────┤
│ 名前           │ メール          │ 役割           │
├────────────────┼─────────────────┼───────────────┤
│ 田中太郎        │ tanaka@...     │ [CHEF ▼]       │
│ 佐藤花子        │ sato@...       │ [SERVICE ▼]    │
│ 鈴木一郎        │ suzuki@...     │ [PURCHASER ▼]  │
│ 山田次郎        │ yamada@...     │ PRODUCER (自分) │
└─────────────────────────────────────────────────┘
```

- テーブル形式でユーザー一覧表示
- 役割列: ドロップダウンでロール変更（即時反映）
- 自分自身のロールは変更不可（ドロップダウンを無効化）
- PRODUCERロールのユーザーのみアクセス可能

**2. ダッシュボードページ (`/`) — ログイン後ホーム画面**

```
┌─────────────────────────────────────────────────┐
│ ようこそ、田中さん（CHEF）                         │
├─────────────────────────────────────────────────┤
│                                                 │
│ ── クイックアクション ──                           │
│ [レシピ作成] [ナレッジ投稿] [AI相談] [FB登録]       │
│ ※ロールに応じて表示するボタンを変える                 │
│                                                 │
│ ── 最近更新されたレシピ ──                         │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│ │ レシピA   │ │ レシピB   │ │ レシピC   │         │
│ └──────────┘ └──────────┘ └──────────┘         │
│                                                 │
└─────────────────────────────────────────────────┘
```

- ロール別ウェルカムメッセージ
- クイックアクション: ロールに応じた操作ボタン
- 最近更新されたレシピ: 直近数件のレシピカードを表示

### 対応するバックエンドAPI

| 操作 | API | 画面 |
|------|-----|------|
| 自分の情報取得 | `GET /api/users/me` | AuthContext（全画面共通） |
| ユーザー一覧取得 | `GET /api/users` | ユーザー管理ページ |
| ロール変更 | `PUT /api/users/{id}/role` | ユーザー管理ページ |

### フロントエンドファイル構成

- `src/api/users.ts` — ユーザーAPI呼び出し関数
- `src/hooks/useUsers.ts` — TanStack Query hooks
- `src/pages/admin/UserManagementPage.tsx` — メンバー管理ページ
- `src/pages/DashboardPage.tsx` — ダッシュボード（ホーム画面）

---

## コーディング規約

### 命名規則

- 変数名・メソッド名: lowerCamelCase
  - 良い例: recipeId, getIngredientList(), isPublished
  - 悪い例: recipe_id, RecipeID, get_ingredient_list()
- クラス名: UpperCamelCase
  - 良い例: RecipeService, CookingStepRepository
  - 悪い例: recipeService, recipe_service
- 定数: UPPER_SNAKE_CASE
  - 良い例: MAX_RECIPE_TITLE_LENGTH, DEFAULT_PAGE_SIZE
  - 悪い例: maxRecipeTitleLength, max_recipe_title_length

### 例外処理

- 素のRuntimeExceptionは禁止。必ずカスタム例外を使う
- 例外の種類によってHTTPステータスコードを自動マッピングする:
  - BusinessLogicException → 400 Bad Request
  - ResourceNotFoundException → 404 Not Found
  - UnauthorizedException → 401 Unauthorized
  - ForbiddenException → 403 Forbidden
  - ApplicationException → 500 Internal Server Error

### Repository層

- 戻り値はOptional型で統一する
  - 良い例: Optional<Recipe> findByRecipeId(Long recipeId)
  - 悪い例: Recipe findByRecipeId(Long recipeId)

---

## アーキテクチャ

- Controller → Service → Repository の3層構造を守る
- 各層の責務:
  - Controller: リクエストの受付、バリデーション、レスポンス整形
  - Service: ビジネスロジック、権限チェック、トランザクション管理
  - Repository: データアクセス
- DTOとEntityは必ず分離する。Entityを直接レスポンスに使わない
- レシピ更新時は必ずRecipeHistoryに変更履歴を記録する

### 食材マスタと原価管理のルール

- 食材はマスタ（Ingredient）で一元管理し、RecipeIngredientはマスタへの参照を持つ
  - 同じ食材を複数レシピで共有し、価格変更を1箇所で反映可能にする
- 食材価格はIngredientPriceで時系列管理する（有効開始日〜有効終了日）
  - 現在有効な価格 = 有効開始日 <= 現在日 かつ 有効終了日がnullまたは現在日以降
- レシピ原価は自動計算する:
  - レシピ原価 = Σ（各食材の現在単価 × 使用量）
  - 推奨売価 = レシピ原価 ÷ (1 - 目標粗利率)
- 食材の価格・供給状態が変更された場合、影響を受けるレシピの一覧を取得できるAPIを提供する
- 食材変更時の通知フロー:
  1. 調達係が食材マスタ（価格・供給状態）を更新
  2. 影響を受けるレシピの原価を再計算
  3. 粗利率が目標を下回るレシピを警告リストとして返す
  4. シェフが警告リストを確認し、レシピ見直し or 売価変更を判断

### アーカイブ機能のルール

- アーカイブは論理的な非公開状態であり、データは保持される
- アーカイブされたレシピは通常の一覧APIでは返さない（フィルタで取得可能）
- アーカイブからPUBLISHEDへの復元が可能（季節メニューの再開など）
- アーカイブ時・復元時もRecipeHistoryに記録する
- 食材のUNAVAILABLE化に伴い、該当食材を使うレシピの一括アーカイブ候補を提示できる

### POSデータ取り込みと理論原価のルール

- POSデータはCSVファイルで店舗別にアップロードする
  - CSVフォーマット: 店舗コード, レシピコード, 対象年月(YYYY-MM), 出数, 売上金額
  - アップロード時にバリデーション（存在しない店舗コード・レシピコードのエラー検出）を行う
  - 同一店舗・同一年月の再アップロードは上書き（既存データを置換）とする
- 理論原価の計算:
  - 商品別理論原価 = レシピ原価（RecipeCost.totalIngredientCost）× 出数
  - 店舗月次理論原価 = Σ（各商品の理論原価）
  - 理論原価率 = 店舗月次理論原価 ÷ 売上合計 × 100
- 計算結果はStoreMonthlyFoodCostにスナップショットとして保存する
  - 食材価格の変更後に再計算APIで最新の原価に基づいた再計算が可能
- 店舗間の理論原価率比較、月次推移の取得APIを提供する

### フィードバックと改善サイクルのルール

- 商品（レシピ）ごとに満足度・感動度（仮）を記録できる
- フィードバックはレシピ・店舗・期間に紐づけて管理する
- 定期的な集計（FeedbackSummary）により、商品の評価傾向を可視化する
- フィードバックの低い商品はレシピ改善のトリガーとする
- フェーズ7では満足度×収益のクロス分析により、「感動度は高いが収益性が低い」等の戦略的インサイトを提供する

---

## テスト方針

- Service層: JUnit 5 + Mockito で単体テスト必須
- Controller層: @WebMvcTest でAPIテスト
- Repository層: @DataJpaTest でクエリ検証
- テストメソッド名は日本語可: `レシピ作成_正常系_シェフが作成できる()`

## ビルド・実行コマンド

```bash
# ビルド
./gradlew build

# テスト実行
./gradlew test

# アプリケーション起動
./gradlew bootRun

# Flywayマイグレーション
./gradlew flywayMigrate
```

## 禁止事項

- System.out.println()でのログ出力 → SLF4J（@Slf4j）を使うこと
- マジックナンバーの直書き → 定数クラスに定義すること
- SQLの直書き → Spring Data JPAのRepositoryメソッドを使うこと
- Controllerから直接Repositoryを呼ぶこと → 必ずServiceを経由すること
- Entityをレスポンスに直接返すこと → 必ずDTOに変換すること
- レシピ更新時に履歴記録を省略すること → 必ずRecipeHistoryに記録すること
- RecipeIngredientに食材名を直接保持すること → 必ずIngredient（食材マスタ）への参照を使うこと
- 食材価格をIngredientエンティティに直接保持すること → 必ずIngredientPrice（価格履歴）で時系列管理すること
- 原価計算をController層で行うこと → 必ずService層で計算ロジックを実装すること
- レシピの物理削除 → 必ず論理削除（ステータスをDELETEDに変更）を使うこと
- CSVパース処理をController層で行うこと → 必ずService層でパース・バリデーションを実装すること
- 理論原価の計算結果を保存せずに毎回再計算すること → StoreMonthlyFoodCostにスナップショットを保存すること
- AI相談のプロンプトをController層で組み立てること → 必ずai/パッケージまたはService層で管理すること
- ナレッジ記事の本文にHTMLを直接保存すること → Markdown形式で保存し、フロントエンド側でレンダリングすること
